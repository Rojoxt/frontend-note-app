<div class="container mx-auto p-4 max-w-6xl">
  <div class="flex items-center justify-between mb-6">
    <div class="flex flex-col sm:flex-row sm:items-center gap-3 w-full sm:w-auto">
      <div class="flex items-center gap-2 w-full sm:w-auto">
        <mat-form-field appearance="fill" class="filter-field">
          <mat-label>Filter by tag</mat-label>
          <input matInput type="text" [matAutocomplete]="autoFilter" [(ngModel)]="filterInput"
                 (keydown.enter)="$event.preventDefault()" aria-label="Filter by tag"/>
          @if (filterTag || filterInput) {
            <button mat-icon-button matSuffix aria-label="Clear filter" (click)="clearFilter()">
              <mat-icon>close</mat-icon>
            </button>
          }
          <mat-autocomplete #autoFilter="matAutocomplete" (optionSelected)="onFilterSelected($event.option.value)">
            @for (t of tags; track t) {
              <mat-option [value]="t.name">{{ t.name }}</mat-option>
            }
          </mat-autocomplete>
        </mat-form-field>
        @if (filterTag) {
          <span class="px-3 py-1 bg-indigo-50 text-indigo-700 rounded-full text-sm flex items-center gap-2">
            {{ filterTag }}
            <button mat-icon-button (click)="clearFilter()" aria-label="Remove filter">
              <mat-icon style="font-size:14px">close</mat-icon>
            </button>
          </span>
        }
      </div>
    </div>
  </div>

  <div class="space-y-6">
    <h2 class="text-2xl font-semibold mt-2 mb-4">Active notes</h2>

    @if (loading) {
      <div class="py-8 text-center">Loading notes...</div>
    }
    @if (notes.length) {
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
        @for (note of notes; track note.id) {
          <mat-card
            class=" bg-white rounded-2xl border border-gray-100 shadow-sm hover:shadow-lg transform hover:-translate-y-1 transition duration-200 overflow-hidden">

            <div class="p-4 md:p-5 flex-1 flex flex-col">
              <mat-card-title class="text-lg font-semibold text-slate-900 mb-2 truncate">{{ note.title }}
              </mat-card-title>
              <mat-card-content class="text-slate-600 text-sm mb-4 line-clamp-4">{{ note.content }}</mat-card-content>

              <div class="mt-3 flex flex-wrap gap-2">
                @if (note.tags?.length) {
                  @for (tag of note.tags; track tag.name) {
                    <span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded-full text-xs flex items-center gap-2">
                        {{ tag.name }}
                      <button mat-icon-button class="ml-2" aria-label="Remove tag"
                              (click)="removeTagFromNote(note, tag.name)" [disabled]="removing[note.id + '']">
                          <mat-icon class="text-xs">close</mat-icon>
                        </button>
                      </span>
                  }
                } @else {
                  <span class="text-gray-400 text-xs">No tags</span>
                }
              </div>

              <div class="mt-auto"></div>
            </div>

            <mat-card-actions
              class="flex items-center justify-between gap-3 px-4 py-3 border-t border-gray-50 bg-white">
              <div class="text-xs text-gray-400">{{ note.updatedAt ? (note.updatedAt | date:'short') : '' }}</div>
              <div class="flex items-center gap-2">
                <button mat-button color="primary"
                        class="text-indigo-600 hover:bg-indigo-50 rounded-md px-2 py-1 focus:outline-none"
                        (click)="archive(note)">Archive
                </button>

                <button mat-icon-button matTooltip="Tags" (click)="openTagPicker(note)">
                  <mat-icon>label</mat-icon>
                </button>

                <button mat-icon-button matTooltip="Edit" (click)="edit(note)">
                  <mat-icon>edit</mat-icon>
                </button>

                <button mat-icon-button matTooltip="Delete" (click)="delete(note)">
                  <mat-icon>delete</mat-icon>
                </button>

              </div>
            </mat-card-actions>

          </mat-card>
        }
      </div>
    } @else {
      <div class="empty-state text-center py-8">
        <div
          class="icon w-16 h-16 mx-auto mb-3 rounded-md bg-gradient-to-br from-indigo-50 to-white flex items-center justify-center text-indigo-500 text-2xl">
          üóíÔ∏è
        </div>
        <p class="text-gray-600">No notes yet. Create one above to get started.</p>
      </div>
    }
  </div>

  <!-- Floating action buttons: crear nota (centrado inferior) y gestionar etiquetas (a la derecha del FAB) -->
  <div
    class="fixed left-1/2 transform -translate-x-1/2 bottom-5 sm:bottom-6 flex flex-col-reverse sm:flex-row items-center gap-3 z-50 pointer-events-auto"
    aria-hidden="false">
    <button mat-fab class="shadow-lg w-16 h-16 flex items-center justify-center" aria-label="Create note"
            (click)="openCreateNote()" matTooltip="Add note">
      <mat-icon>note_add</mat-icon>
    </button>

    <button mat-mini-fab class="w-10 h-10 flex items-center justify-center" aria-label="Manage tags"
            (click)="openTagManager()" matTooltip="Manage tags">
      <mat-icon>label</mat-icon>
    </button>
  </div>
</div>
